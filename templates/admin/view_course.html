{% extends 'base.html' %}
{% block content %}

<div class="content container-fluid">
    <div class="page-header">
       <div class="row align-items-center">
          <div class="col">
             <h3 class="page-title">Courses</h3>
             <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                <li class="breadcrumb-item active">Courses</li>
             </ul>
          </div>
          <div class="col-auto text-right float-right ml-auto">
             <a href="#" id="downloadBtn" class="btn btn-outline-primary mr-2"><i class="fas fa-download"></i> Download</a>
             <a href="{% url 'add_course' %}" class="btn btn-primary"><i class="fas fa-plus"></i></a>
          </div>
       </div>
    </div>
    {% include 'includes/messages.html' %}
    <div class="row">
       <div class="col-sm-12">
          <div class="card card-table">
             <div class="card-body">
                <div class="table-responsive">
                   <table class="table table-hover table-center mb-0 datatable" id="table_id">
                      <thead>
                         <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Duration</th>
                            <th>Fee</th>
                            <th>Action</th>
                         </tr>
                      </thead>
                      <tbody>
                        {% for i in course %}
                         <tr>
                            <td>{{i.id}}</td>
                            <td>{{i.name}}</td>
                            <td>{{i.duration}}</td>
                            <td>{{i.fee}}</td>
                            {% comment %} <td>{{i.created_at}}</td>
                            <td>{{i.updated_at}}</td> {% endcomment %}
                            <td>
                               <div class="actions">
                                  <a href="{% url 'edit_course' i.id %}" class="btn btn-sm bg-success-light mr-2">
                                  <i class="fas fa-pen"></i>
                                  </a>
                                  <a href="{% url 'delete_course' i.id %}" class="btn btn-sm bg-danger-light" onclick="return confirm('Are you sure you want to delete this item?');">
                                  <i class="fas fa-trash"></i>
                                  </a>
                               </div>
                            </td>
                         </tr>
                         {% endfor %}
                      </tbody>
                   </table>
                </div>
             </div>
          </div>
       </div>
    </div>
 </div>

 <script>
   document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('downloadBtn').addEventListener('click', function(event) {
          event.preventDefault(); // Prevent default behavior
          
          // Fetch data from all pages
          var allCourses = [];
          var currentPage = 1;
          
          function fetchCourses(page) {
              fetch('your-backend-url?page=' + page)
                  .then(response => response.json())
                  .then(data => {
                      allCourses.push(...data.courses);
                      if (data.has_next_page) {
                          currentPage++;
                          fetchCourses(currentPage);
                      } else {
                          generateExcelFile(allCourses);
                      }
                  })
                  .catch(error => console.error('Error fetching courses:', error));
          }
          
          fetchCourses(currentPage);
      });
      
      function generateExcelFile(coursesData) {
          // Create a table element
          var table = document.createElement('table');
          table.innerHTML = '<thead><tr><th>ID</th><th>Name</th><th>Duration</th><th>Fee</th></tr></thead><tbody></tbody>';
          var tbody = table.querySelector('tbody');
          
          // Populate table with data
          coursesData.forEach(function(course) {
              var row = document.createElement('tr');
              row.innerHTML = `<td>${course.id}</td><td>${course.name}</td><td>${course.duration}</td><td>${course.fee}</td>`;
              tbody.appendChild(row);
          });
          
          // Convert table to Excel sheet
          var workbook = XLSX.utils.table_to_book(table);
  
          // Generate Excel file
          var excelFile = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });
  
          // Convert binary string to Blob
          var blob = new Blob([s2ab(excelFile)], { type: "application/octet-stream" });
  
          // Trigger download
          saveAs(blob, 'courses.xlsx');
      }
      
      function s2ab(s) {
          var buf = new ArrayBuffer(s.length);
          var view = new Uint8Array(buf);
          for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
          return buf;
      }
  });
</script>

{% endblock %}